<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Instrument Tuner - VIBELAND</title>
  <link rel="stylesheet" type="text/css" href="../assets/styles.css">
  <style>
    .tuner-container {
      background-color: #ffffff;
      border: 2px inset #c0c0c0;
      padding: 20px;
      margin: 20px 0;
      text-align: center;
    }

    #note {
      font-size: 48px;
      font-weight: bold;
      color: #000080;
      margin: 10px 0;
    }

    #cents {
      font-size: 24px;
      color: #000;
      margin: 10px 0;
    }

    #controls {
      margin-top: 20px;
    }

    input[type="number"] {
      padding: 5px;
      border: 2px inset #c0c0c0;
      font-family: "Times New Roman", serif;
    }

    button {
      padding: 10px 20px;
      font-size: 14px;
    }

    canvas {
      margin: 20px auto;
      display: block;
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="outer-border">
      <div class="header">
        <h1>üéµ INSTRUMENT TUNER üéµ</h1>
        <p>~*~ Tune Your Instrument ~*~</p>
      </div>

      <div class="ticker" aria-label="site news">
        <div class="marquee">‚òÖ WELCOME TO VIBELAND ‚òÖ GET IN TUNE AND PLAY PERFECTLY ‚òÖ</div>
      </div>

      <div class="content">
        <div class="tuner-container">
          <div id="note">--</div>
          <div id="cents">0 cents</div>
          <canvas id="meter" width="300" height="50"></canvas>
          <div id="controls">
            <label for="a4-freq">A4 Frequency (Hz):</label>
            <input type="number" id="a4-freq" value="440" min="400" max="500" step="1">
            <button id="toggle-btn">Start Tuner</button>
          </div>
        </div>
        
        <hr class="thick">
        
        <div class="footer">
          <div><a href="../home">‚Üê Back to VIBELAND</a></div>
          <div>¬© 1999 VIBELAND - All Rights Reserved</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // JavaScript for the instrument tuner functionality

    // Global variables
    let audioContext;
    let analyser;
    let microphone;
    let stream;
    let a4Freq = 440; // Default A4 frequency
    let isRunning = false;
    let animationId;
    let lastFreq = -1;
    let holdFrames = 0;
    const HOLD_FRAMES = 12; // Hold for ~200ms at 60fps

    // Note names array (starting from C)
    const noteNames = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];

    // Function to toggle tuner start/stop
    async function toggleTuner() {
      if (!isRunning) {
        await startTuner();
      } else {
        stopTuner();
      }
    }

    // Function to start the tuner
    async function startTuner() {
      try {
        // Request microphone access
        stream = await navigator.mediaDevices.getUserMedia({audio: true});
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        analyser = audioContext.createAnalyser();
        analyser.fftSize = 2048;
        analyser.minDecibels = -100;
        analyser.maxDecibels = -10;
        analyser.smoothingTimeConstant = 0.85;

        microphone = audioContext.createMediaStreamSource(stream);
        microphone.connect(analyser);

        isRunning = true;
        lastFreq = -1;
        holdFrames = 0;
        document.getElementById("toggle-btn").textContent = "Stop Tuner";
        document.getElementById("toggle-btn").classList.add("stop");

        // Start the update loop
        updatePitch();
      } catch (err) {
        console.error("Error accessing microphone:", err);
        alert("Unable to access microphone. Please check permissions.");
      }
    }

    // Function to stop the tuner
    function stopTuner() {
      isRunning = false;
      if (animationId) {
        cancelAnimationFrame(animationId);
      }
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
      }
      if (audioContext) {
        audioContext.close();
      }
      document.getElementById("toggle-btn").textContent = "Start Tuner";
      document.getElementById("toggle-btn").classList.remove("stop");
      // Reset display
      document.getElementById("note").textContent = "--";
      document.getElementById("cents").textContent = "0 cents";
      drawMeter(0);
      lastFreq = -1;
      holdFrames = 0;
    }

    // Function to update pitch using requestAnimationFrame
    function updatePitch() {
      if (!isRunning) return;

      const bufferLength = analyser.fftSize;
      const buffer = new Float32Array(bufferLength);
      analyser.getFloatTimeDomainData(buffer);

      // Use autocorrelation to find the pitch
      const pitch = autoCorrelate(buffer, audioContext.sampleRate);

      if (pitch > 0) {
        lastFreq = pitch;
        holdFrames = HOLD_FRAMES;
        updateDisplay(pitch);
      } else {
        if (holdFrames > 0) {
          holdFrames--;
          updateDisplay(lastFreq);
        } else {
          // Show no signal
          document.getElementById("note").textContent = "--";
          document.getElementById("cents").textContent = "No signal";
          drawMeter(0);
        }
      }

      animationId = requestAnimationFrame(updatePitch);
    }

    // Improved autocorrelation function for pitch detection with mean subtraction
    function autoCorrelate(buffer, sampleRate) {
      const SIZE = buffer.length;
      let sum = 0;
      let rms = 0;
      for (let i = 0; i < SIZE; i++) {
        sum += buffer[i];
        rms += buffer[i] * buffer[i];
      }
      const mean = sum / SIZE;
      rms = Math.sqrt(rms / SIZE);
      if (rms < 0.001) return -1; // Lowered threshold for quieter signals

      // Subtract mean to remove DC bias
      for (let i = 0; i < SIZE; i++) {
        buffer[i] -= mean;
      }

      const MIN_PERIOD = Math.floor(sampleRate / 2000); // Max freq 2000 Hz
      const MAX_PERIOD = Math.floor(sampleRate / 50); // Min freq 50 Hz
      let bestOffset = -1;
      let bestCorrelation = 0;
      const threshold = 0.01; // Lowered threshold

      for (let offset = MIN_PERIOD; offset < Math.min(MAX_PERIOD, SIZE / 2); offset++) {
        let correlation = 0;
        for (let i = 0; i < SIZE - offset; i++) {
          correlation += buffer[i] * buffer[i + offset];
        }
        correlation /= (SIZE - offset);

        if (correlation > bestCorrelation) {
          bestCorrelation = correlation;
          bestOffset = offset;
        }
      }

      if (bestCorrelation > threshold && bestOffset > 0) {
        const freq = sampleRate / bestOffset;
        if (freq > 50 && freq < 2000) { // Valid range for instruments
          return freq;
        }
      }
      return -1;
    }

    // Function to update the display with detected pitch
    function updateDisplay(freq) {
      const {note, cents} = getNoteAndCents(freq);

      // Update note and cents display
      document.getElementById("note").textContent = note;
      document.getElementById("cents").textContent = `${cents.toFixed(0)} cents`;

      // Draw meter
      drawMeter(cents);
    }

    // Function to calculate nearest note and cents deviation
    function getNoteAndCents(freq) {
      // Calculate the MIDI note number relative to A4 (MIDI 69)
      const noteNum = 69 + 12 * Math.log2(freq / a4Freq);
      const roundedNote = Math.round(noteNum);
      const noteIndex = roundedNote % 12;
      const octave = Math.floor(roundedNote / 12) - 1;
      const noteName = noteNames[noteIndex] + octave;

      // Calculate exact frequency of the nearest note
      const noteFreq = a4Freq * Math.pow(2, (roundedNote - 69) / 12);

      // Calculate cents deviation
      const cents = 1200 * Math.log2(freq / noteFreq);

      return {note: noteName, cents};
    }

    // Function to draw the linear tuner meter on canvas
    function drawMeter(cents) {
      const canvas = document.getElementById("meter");
      const ctx = canvas.getContext("2d");
      const width = canvas.width;
      const height = canvas.height;
      const centerX = width / 2;
      const scale = 3; // pixels per cent

      // Clear canvas
      ctx.clearRect(0, 0, width, height);

      // Draw center line
      ctx.strokeStyle = "#ccc";
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.moveTo(0, height / 2);
      ctx.lineTo(width, height / 2);
      ctx.stroke();

      // Draw ticks for -50 to +50 cents
      for (let i = -50; i <= 50; i += 10) {
        const x = centerX + i * scale;
        ctx.beginPath();
        ctx.moveTo(x, height / 2 - 5);
        ctx.lineTo(x, height / 2 + 5);
        ctx.strokeStyle = i === 0 ? "#00ff00" : "#000";
        ctx.lineWidth = i === 0 ? 3 : 1;
        ctx.stroke();
      }

      // Draw needle
      const clampedCents = Math.max(-50, Math.min(50, cents));
      const needleX = centerX + clampedCents * scale;
      ctx.beginPath();
      ctx.moveTo(needleX, 0);
      ctx.lineTo(needleX, height);
      ctx.strokeStyle = "#ff0000";
      ctx.lineWidth = 3;
      ctx.stroke();
    }

    // Event listeners
    document.getElementById("toggle-btn").addEventListener("click", toggleTuner);

    document.getElementById("a4-freq").addEventListener("input", (e) => {
      a4Freq = parseFloat(e.target.value) || 440;
    });
  </script>
</body>
</html>
